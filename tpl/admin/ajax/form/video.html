<{include file="admin/ajax/all/path.html"}>
<div class="p10">
    <form id="newsForm" way='info'>
	   <fieldset class="open">
		  <legend class="openClick">内容<span class="arrow"></span></legend>
		  <div class="openBox clear">
			 <div class="clear">
				<select name="pid" class="sel formVal">
				<{section loop=$pdata name="p"}>
				    <option value="<{$pdata[p].id}>" <{if $smarty.get.pid && $smarty.get.pid==$pdata[p].id}>selected="selected"<{/if}>>所属【<{$pdata[p].name}>】</option>
				    <{/section}>
				</select>
				<select name="chk" class="sel formVal">
				    <option value="0">前端【隐藏】</option>
				    <option value="1" <{if !$data.id || $data.chk}>selected="selected"<{/if}>>前端【显示】</option>
				</select>
				<select name="hchk" class="sel formVal">
				    <option value="0">网站首页【隐藏】</option>
				    <option value="1" <{if $data.hchk}>selected="selected"<{/if}>>网站首页【显示】</option>
				</select>
				<select name="mchk" class="sel formVal">
				    <option value="0">栏目首页【默认】</option>
				    <option value="1" <{if $data.mchk}>selected="selected"<{/if}>>栏目首页【独立】</option>
				</select>
			 </div>
			 <div class="clear">
				<div class="inp notNull">
				    <input type="hidden" name="id" class="formVal" value="<{$data.id}>">
				    <input type="text" name="name" class="formVal" value="<{$data.name}>" maxlength="20">
				    <p class="tit">标题<span>（必填）</span></p>
				</div>
				<div class="inp">
				    <input type="text" name="url" value="<{$data.url}>" class="formVal">
				    <p class="tit">外链地址<span>（外链需加上http/https）</span></p>
				    <div class="faq">添加后，前端进入详情页会自动跳转到该地址。</div>
				</div>
				<div class="inp">
				    <input type="text" name="lname" value="<{$data.lname}>" class="formVal">
				    <p class="tit">列表标题</p>
				    <div class="faq">添加后所有非详情页展示的标题均显示次标题</div>
				</div>
				<div class="inp">
				    <input type="text" name="rank" value="<{if $data.rank}><{$data.rank}><{else}>0<{/if}>" maxlength="11" class="formVal">
				    <p class="tit">排序</p>
				    <div class="faq">1、可空。<br>2、要求纯数字。<br>3、顺序为从大到小降序，最大的排列在最前面，同样大小以添加时间为准</div>
				</div>
				<div class="inp">
				    <input type="text" name="stime" value="<{$data.stime}>" onClick="laydate({istime: true, format: 'YYYY-MM-DD hh:mm:ss'})" maxlength="11" class="formVal laydate-icon" >
				    <p class="tit">显示时间</p>
				</div>
			 </div>
		  </div>
	   </fieldset>
	   <fieldset class="open">
		  <legend class="openClick">列表图片<span class="arrow"></span><span class="faq">【新闻240*165】</span></legend>
		  <div class="openBox clear">
			 <div class="inp notNull inpMax">
				<input type="hidden" name="img" class="formVal" value="<{$data.img}>" box='fileSwfBox'>
				<input class="imgFile" id="imgFile" type="file" txt='上传图片' multiple="true" val="img" max="1">
				<div class="fileSwfBox" val="img"></div>
				<script type="text/javascript">$('#imgFile').upFile();</script>
			 </div>
		  </div>
	   </fieldset>
	   <fieldset class="open">
		  <legend class="openClick">视频管理<span class="arrow"></span><span class="faq">【为兼容视频格式限制为MP4,编码h264】</span></legend>
		  <div class="openBox clear">
			 <div class="inp notNull inpMax">
				<input type="hidden" name="video" class="formVal" value="<{$data.video}>" box='fileSwfBox'>
				<input class="imgFile" id="videoFile" type="file" txt='上传视频' multiple="true" val="video" max="1">
				<div class="fileSwfBox" val="img"></div>
				<script type="text/javascript">$('#videoFile').upFile();</script>
			 </div>
		  </div>
	   </fieldset>
	   <fieldset class="open close">
		  <legend class="openClick">内容<span class="arrow"></span></legend>
		  <div class="openBox clear dn">
			 <div class="clear">
				<select name="cchk" class="sel formVal">
				    <option value="0">展示样式【图文】</option>
				    <option value="1" <{if $data.cchk}>selected="selected"<{/if}>>展示样式【大图】</option>
				</select>
			 </div>
			 <div class="ccont clear">
				<div class="textarea <{if $data.ccont}>val<{/if}>"><textarea name="ccont" class="formVal"><{$data.ccont}></textarea><p class="tit">摘要</p></div>
			 </div>
			 <div class="imageBox clear">
				<script id="imageBoxsVal" type="text/plain"><{if $data.cchk=='1'}><{$data.cont}><{/if}></script>
				<script id="imageBoxs" type="text/plain">
				    <div class="imageBoxs clear">
					   <div class="img">
						  <img src="/upload/null.png">
						  <input type="file" class="file" value="">
						  <input type="hidden" value="">
						  <div class="inp"><input type="text" value="" maxlength="11"><p class="tit">alt<span>（鼠标停留提示）</span></p></div>
					   </div>
					   <div class="textarea"><textarea></textarea><p class="tit">文本区域</p></div>
					   <a href="javascript:" class="removeImageBoxs" onclick="if(confirm('确认删除？'))$(this).parent().remove();">×</a>
				    </div>
				</script>
				<a href="javascript:" class="addClick efColor addImageBoxs">添加[大图]模块</a>
			 </div>
			 <div class="editorBox">
				<script id="editor<{$sign}>" type="text/plain" style="width:100%;height:200px;"><{if $data.cchk=='0'}><{$data.cont}><{/if}></script>
			 </div>
		  </div>
	   </fieldset>
	   <fieldset class="open close">
		  <legend class="openClick">SEO<span class="arrow"></span></legend>
		  <div class="openBox clear dn">
			 <div class="inp">
				<input type="text" name="seoTitle" class="formVal" value="<{$data.seoTitle}>">
				<p class="tit">Title</p>
			 </div>
			 <div class="inp">
				<input type="text" name="seoKeyWord" class="formVal" value="<{$data.seoKeyWord}>">
				<p class="tit">KeyWords</p>
			 </div>
			 <div class="inp">
				<input type="text" name="seoDes" class="formVal" value="<{$data.seoDes}>">
				<p class="tit">Description</p>
			 </div>
		  </div>
	   </fieldset>
	   <div class="inp sub">
		  <a href="javascript:" class="tit efColor">提交保存</a>
		  <input type="submit" class="dn">
	   </div>
    </form>
</div>
<script type="text/javascript">
if($('#edui_fixedlayer').size()>0)$('#edui_fixedlayer').remove();
var ue = UE.getEditor('editor<{$sign}>');
$('form .inp input').each(function(){
    if($(this).val()){
	   $(this).parent().addClass('val');
    }else{
	   $(this).parent().removeClass('val');
    }
})
$('select[name="cchk"]').change(function(){
    if($(this).val()>0){
	   $('.editorBox').hide().siblings('.imageBox').show();
    }else{
	   $('.editorBox').show().siblings('.imageBox').hide();
    }
})
$('select[name="cchk"]').change();
$('.addImageBoxs').click(function(){
    $(this).before($('#imageBoxs').html());
})
var addImageBoxs=$('#imageBoxs').html()
if($('#imageBoxsVal').html()){
    var imageBoxsVal=eval($('#imageBoxsVal').html());
    $.each(imageBoxsVal,function(k,v){
	   $('.addImageBoxs').before(addImageBoxs);
	   var $p=$('.imageBoxs').last();
	   $p.find('input[type="hidden"]').val(v.img)
	   $p.find('input[type="text"]').val(v.alt)
	   $p.find('img').attr('src','/upload/'+v.img)
	   $p.find('.textarea,.inp').addClass('val')
	   $p.find('textarea').val(v.cont)
    })
}else{
    $('.addImageBoxs').before(addImageBoxs);
}
$(".file").uploadFile('imageBoxShow');
function imageBoxShow(id,data){
    if(id && data){
	   $("#"+id).siblings('input[type="hidden"]').val(data.img);
	   $("#"+id).siblings('.inp').find('input[type="text"]').val(data.name).focus();
	   $("#"+id).siblings('img').attr('src','/upload/'+data.img);
    }
}
$('#newsForm').submit(function(){
    var obj=$(this),data={action:'sure'};
    data['way']=obj.attr('way');
    $(this).find('.formVal').each(function(){
	   data[$(this).attr('name')]=$(this).val();
    })
    if(data['cchk']>0){
	   data['cont']='';
	   $('.imageBoxs').each(function(){
		  if(data['cont'])data['cont']+=',';
		  data['cont']+='{"img":"'+$(this).find('input[type="hidden"]').val()+'","alt":"'+$(this).find('input[type="text"]').val()+'","cont":"'+$(this).find('textarea').val()+'"}';
	   })
	   if(data['cont'])data['cont']='['+data['cont']+']';
    }else{
	   data['cont']=ue.getContent();
    }
    if(!data['name']){alertLj('标题不能为空');return false;}
    if(obj.hasClass('lj'))return false;
    $.ajax({
	   type:'post',data:data,url:basic.path+'handle/post/',dataType:'json',beforeSend:function(XMLHttpRequest){
		  basicHeader(XMLHttpRequest,'json');obj.addClass('lj');alertLj('load');
	   },success:function(msg){
		  obj.removeClass('lj');
		  if(msg.error>0){
			 alertLj(msg.html);
		  }else if(msg.error==0){
			 if(data.id)
				alertLj(msg.html);
			 else
				alertLj(msg.html,{ok:'继续添加',click:"alertLjClose($('.refreshFormClick').click())",cancel:true,cancelClick:"alertLjClose($('.retrunFormClick').click())"});
		  }else{
			 alertLj(msg.html,{ok:'未知错误，刷新页面',click:"window.location.reload()",cancel:false});
		  }
		  $('.alertSure').focus();
		  $('.alertSure').select();
	   },error:function(error){
		  obj.removeClass('lj')
		  errHandle(error);
	   }
    })
    return false;
})
</script>